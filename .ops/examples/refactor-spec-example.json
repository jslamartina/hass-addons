{
  "$schema": "../schema/refactor-spec.v1.schema.json",
  "plan_id": "rf-2025-10-28-TCP-packet-parser",
  "goal": "Reduce complexity and duplication in tcp_device parser; keep public API stable.",
  "scope": {
    "include": ["src/**/*.ts", "tests/**/*.ts"],
    "exclude": ["**/vendor/**", "**/gen/**", "**/*.snap"]
  },
  "invariants": [
    "Public exports under src/api/** MUST NOT change names or signatures.",
    "All existing tests MUST pass; coverage MUST NOT drop by more than 0.5%.",
    "No raw SQL; keep Prisma as the data layer."
  ],
  "changes": [
    {
      "type": "codemod.renameSymbol",
      "find": "parse_packet",
      "replace": "parsePacket",
      "where": ["src/**/*.ts"],
      "safety": "types-first"
    },
    {
      "type": "codemod.extractFunction",
      "from": "src/parser/tcp.ts",
      "selection_hint": "lines ~120-240 (status broadcast parsing)",
      "new_function": "parseStatusBroadcast",
      "target_file": "src/parser/status.ts"
    },
    {
      "type": "codemod.replaceImport",
      "from": "@/utils/logger",
      "to": "@/core/logging"
    }
  ],
  "batches": {
    "strategy": "by-folder",
    "size_limits": { "files_max": 20, "diff_lines_max": 800 }
  },
  "checks": {
    "commands": [
      { "name": "typecheck", "run": "pnpm tsc -p tsconfig.json --noEmit" },
      { "name": "lint", "run": "pnpm eslint . --max-warnings=0" },
      { "name": "unit", "run": "pnpm vitest run --reporter=junit" }
    ],
    "must_pass": ["typecheck", "lint", "unit"],
    "metrics": { "coverage_drop_max": 0.5 }
  },
  "telemetry": [
    "count TODO/FIXME before vs after",
    "cyclomatic complexity delta for src/parser/**",
    "bundle size delta for parser chunk"
  ],
  "abort_if": [
    "More than 1 test file fails in a batch.",
    "Any file under src/api/** is modified.",
    "Diff exceeds 800 lines or 20 files in a batch."
  ],
  "fallbacks": [
    "If typecheck fails due to signature drift, generate minimal adapter shims instead of changing public API.",
    "If complexity does not drop by >=10% after extract, revert and try alternative split points."
  ],
  "rollback": {
    "strategy": "git-revert-batch",
    "keep_files": ["migrations/**", "package.json", "pnpm-lock.yaml"]
  },
  "artifacts": {
    "expected": [
      "PR title/description per batch with summary of changes and metrics",
      "Changelog entry under CHANGELOG.md",
      "Diffstat and complexity report"
    ]
  },
  "execution": {
    "dry_run": true,
    "max_retries_per_step": 2,
    "confirm_each_batch": true,
    "output_policy": "minimal_diff_with_rationale"
  }
}
