---
description: Browser testing with Playwright patterns and workarounds
appliesTo:
  - "cync-controller/tests/e2e/**/*.ts"
  - "scripts/playwright/**"
---

# Browser Testing with Playwright

**When to use:** Manual UI verification or when API tools are insufficient.

## Critical Patterns
**!! IT IS CRITICAL TO UNDERSTAND THE ENTIRE UI IS SHADOW-DOM BASED YOU CANNOT USE CONVENTIONAL SELECTORS !!**
### 1. Stable Selectors - Prefer Accessibility Hierarchy

**Priority order:**
1. Role-based: `getByRole("button", { name: "Save" })`
2. Label-based: `getByLabel("Username")`
3. Test ID: `getByTestId("submit-btn")` (if added to HA)
4. Text: `getByText("Exact match")`
5. **Avoid:** `nth()`, CSS selectors, XPath (brittle)

```typescript
// ❌ WRONG: querySelector can't find inputs in shadow roots
const input = page.locator("ha-data-table input");

// ❌ WRONG: Brittle nth() selector
await page.locator("div").nth(5).click();

// ✅ CORRECT: Role-based selector pierces shadow DOM
const searchInput = page.getByRole("textbox", { name: /^Search/i });
await searchInput.fill("Hallway");

// ✅ CORRECT: Stable, semantic selector
await page.getByRole("button", { name: /save/i }).click();
```

### 2. SVG Click Interception - Click Parent Containers
```typescript
// ❌ WRONG: Click button directly (fails with SVG)
await page.getByRole("button", { name: "Toggle" }).click();

// ✅ CORRECT: Click the entity card container
await page.locator("div").filter({ hasText: "Hallway Lights" }).nth(5).click();
```

### 3. Iframe Access - Use frameLocator
```typescript
const frame = page.frameLocator("iframe");
await frame.getByRole("link", { name: /Configuration/i }).click();
```

### 4. MQTT Entity Deletion - Stop Integration First
```typescript
// 1. Stop add-on
await stopAddon("local_cync-controller");

// 2. Wait for entities unavailable
await page.waitForTimeout(30000);

// 3. NOW delete entities
await page.getByText("Delete selected").click();
```

## Common Selectors

```typescript
// Login
await page.getByRole("textbox", { name: "Username*" }).fill("dev");
await page.getByRole("textbox", { name: "Password*" }).fill("dev");
await page.getByRole("button", { name: "Log in" }).click();

// Sliders (safe - no SVG interference)
await page.getByRole("slider", { name: "Brightness" }).click();

// Switches
await page.getByRole("switch", { name: /Debug/i }).click();

// Close dialog
await page.getByLabel("Close").click();
// Or: await page.keyboard.press("Escape");

// Navigate
await page.getByRole("link", { name: "Settings" }).click();
await page.getByRole("link", { name: "Devices & services" }).click();
```

## Anti-Patterns

```typescript
// ❌ DON'T: Force clicks (bypasses safety checks)
await page.getByRole("button").click({ force: true });

// ❌ DON'T: CSS selectors for shadow DOM content
const input = page.locator("ha-data-table input");

// ❌ DON'T: Click SVG elements directly
await page.locator("svg").click();

// ✅ DO: Click parent containers, use role-based selectors, click interactive elements
```

## Test Configuration

### Login State Reuse
```typescript
// Save auth state once
test.use({ storageState: "auth.json" });

// Or login helper
async function login(page: Page) {
  await page.getByRole("textbox", { name: "Username*" }).fill("dev");
  await page.getByRole("textbox", { name: "Password*" }).fill("dev");
  await page.getByRole("button", { name: "Log in" }).click();
  await page.context().storageState({ path: "auth.json" });
}
```

### Test Defaults
```typescript
test.use({
  baseURL: "http://homeassistant.local:8123",
  headless: true,  // CI-friendly
  timezone: "UTC",
  locale: "en-US",
});
```

### Retries and Tracing
```bash
# Always use --reporter=list and tracing
npx playwright test --reporter=list --trace on-first-retry --retries=2
```

### Assertions Over Waits
```typescript
// ❌ WRONG: Arbitrary timeout
await page.waitForTimeout(5000);

// ✅ CORRECT: Wait for condition
await expect(page.getByText("Success")).toBeVisible();
await expect(page).toHaveURL(/dashboard/);
```

## Credentials

- File: `/workspaces/hass-addons/hass-credentials.env`
- Username: `dev`
- Password: `dev`

## When NOT to Use

- ❌ Configuration changes (use `scripts/configure-addon.sh`)
- ❌ Bulk operations (use API or Python scripts)
- ❌ Simple status checks (use `ha` CLI commands)
- ❌ Log inspection (use `ha addons logs`)

**Rule:** Prefer API tools over browser automation whenever possible.
