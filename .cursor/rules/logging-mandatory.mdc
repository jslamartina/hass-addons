---
description: Critical logging requirements for all code changes
appliesTo:
  - "**/*.py"
---

# CRITICAL: LOGGING IS MANDATORY

Always add comprehensive, structured logging to code changes. Proper logging is critical for debugging.

## Setup

```python
from cync_controller.logging_abstraction import get_logger
from cync_controller.correlation import ensure_correlation_id
from cync_controller.instrumentation import timed_async

logger = get_logger(__name__)
```

## When to Log

### Always Log

- Function entry/exit (especially async)
- State changes (with before/after values)
- External operations (File I/O, network)
- Error paths (all exception handlers)
- Configuration loading
- User actions

### Don't Log

- Sensitive data (tokens, passwords)
- Excessive loop iterations (log summary instead)
- Already-logged information
- Redundant "Entering function" without context

## Log Format

**CRITICAL**: Always use structured logging with `extra={}` dict. Never use `%` formatting or `| key=value` in message strings.

### Standardized Format

```python
## Simple messages (no context needed)
logger.info("→ Starting operation")
logger.info("✓ Operation completed")
logger.error("✗ Operation failed")

## Structured context (ALWAYS use extra={} dict)
logger.info(
    "Device state changed",
    extra={
        "device_id": device_id,
        "old_state": "OFF",
        "new_state": "ON",
    },
)

## With formatted values (put in extra={}, not message)
logger.debug(
    "Queued packet type 0x%02x",
    packet.packet_type,
    extra={"packet_type": packet.packet_type},
)

## Error logging with context
logger.exception(
    "Operation failed",
    extra={
        "operation": "handshake",
        "attempt": attempt + 1,
        "max_retries": max_retries,
        "error": str(e),
        "error_type": type(e).__name__,
    },
)

## Performance timing
@timed_async("mqtt_publish")
async def publish_message(topic, payload):
    await client.publish(topic, payload)
```

### Anti-Patterns

```python
## ❌ WRONG: Using % formatting in message
logger.debug("Queued packet type 0x%02x", packet.packet_type)

## ✅ CORRECT: Put value in extra={}
logger.debug(
    "Queued packet type 0x%02x",
    packet.packet_type,
    extra={"packet_type": packet.packet_type},
)

## ❌ WRONG: Using | key=value format in message
logger.info("Triggering reconnection | reason=%s", reason, extra={"reason": reason})

## ✅ CORRECT: Clean message, context in extra={}
logger.info(
    "Triggering reconnection",
    extra={"reason": reason},
)

## ❌ WRONG: Mixing formats
logger.warning("Heartbeat ACK timeout (%.1fs)", heartbeat_timeout)

## ✅ CORRECT: Structured logging
logger.warning(
    "Heartbeat ACK timeout (%.1fs)",
    heartbeat_timeout,
    extra={"device_id": device_id, "heartbeat_timeout": heartbeat_timeout},
)
```

### Key Principles

1. **Message strings**: Keep clean and descriptive, use visual prefixes (`→`, `✓`, `✗`, `⚠️`)
2. **Context data**: Always put in `extra={}` dict, never in message string
3. **Formatted values**: If you need `%` formatting for display, include both in message AND `extra={}`
4. **Consistency**: All logs should follow this pattern for easy parsing and filtering

## Log Levels

- **DEBUG**: Detailed diagnostics (packet contents, internal state)
- **INFO**: Important events (connections, state changes)
- **WARNING**: Unexpected situations (recovered, retries)
- **ERROR**: Failures affecting functionality
- **CRITICAL**: System-wide failures

## Checklist

- [ ] Used `get_logger(__name__)`
- [ ] Added `ensure_correlation_id()` in async entry points
- [ ] Function entry/exit logged
- [ ] Error cases logged with structured context
- [ ] State changes logged with before/after values
- [ ] Used visual prefixes: `→`, `✓`, `✗`, `⚠️`

## Related

- See `docs/developer/logging-system.md` for implementation details
