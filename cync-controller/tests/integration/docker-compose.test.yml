version: "3.8"

services:
  # EMQX MQTT Broker for testing
  emqx:
    image: emqx/emqx:5.8.0
    container_name: cync_test_emqx
    ports:
      - "11883:1883" # MQTT (use 11883 externally to avoid conflict with HA's EMQX)
      - "28083:18083" # Dashboard (use 28083 externally to avoid conflict)
    environment:
      - EMQX_NAME=test_broker
      - EMQX_HOST=127.0.0.1
      - EMQX_ALLOW_ANONYMOUS=true
      - EMQX_LISTENERS__TCP__DEFAULT__ENABLE_AUTHN=false
    healthcheck:
      test: ["CMD", "emqx", "ping"]
      interval: 5s
      timeout: 10s
      retries: 5
    networks:
      - cync_test_network

  # Cync Controller Add-on under test
  cync-controller:
    build:
      context: ../..
      dockerfile: Dockerfile
      args:
        BUILD_FROM: python:3.13-alpine
        BUILD_ARCH: amd64
        BUILD_VERSION: test
    container_name: cync_test_controller
    command: sh /test/start-test.sh
    depends_on:
      emqx:
        condition: service_healthy
    environment:
      - CYNC_HOST=0.0.0.0
      - CYNC_DEBUG=1
      - CYNC_RAW_DEBUG=1
      - CYNC_TOPIC=cync_lan_test
      - CYNC_PERSISTENT_BASE_DIR=/data/config
      - CYNC_MQTT_HOST=emqx
      - CYNC_MQTT_PORT=1883
      - CYNC_MQTT_USER=test_user
      - CYNC_MQTT_PASS=test_pass
      - CYNC_HASS_TOPIC=homeassistant
      - CYNC_HASS_STATUS_TOPIC=status
      - CYNC_HASS_BIRTH_MSG=online
      - CYNC_HASS_WILL_MSG=offline
      - CYNC_MQTT_CONN_DELAY=2
      - CYNC_CMD_BROADCASTS=2
      - CYNC_MAX_TCP_CONN=8
      - CYNC_TCP_WHITELIST=""
      # Cloud relay options (disabled by default for LAN-only testing)
      - CYNC_CLOUD_RELAY_ENABLED=false
      - CYNC_CLOUD_FORWARD=false
    ports:
      - "33779:23779" # Device TCP port (use 33779 externally to avoid conflict)
      - "33778:23778" # Web interface (use 33778 externally to avoid conflict)
      - "15678:5678" # Debug port (use 15678 externally to avoid conflict)
    volumes:
      - ./fixtures:/data/fixtures:ro
      - ./start-test.sh:/test/start-test.sh:ro
      - test_config:/data/config
    networks:
      - cync_test_network
    healthcheck:
      test: ["CMD", "nc", "-z", "127.0.0.1", "23779"]
      interval: 5s
      timeout: 5s
      retries: 3

  # Mock Cync Device for testing
  mock-device:
    build:
      context: ./mock-device
      dockerfile: Dockerfile
    container_name: cync_test_device
    depends_on:
      cync-controller:
        condition: service_healthy
    environment:
      - CYNC_SERVER_HOST=cync-controller
      - CYNC_SERVER_PORT=23779
      - DEVICE_ID=0x1234
      - DEVICE_NAME=Test Light 1
      - DEVICE_ROOM=Living Room
    volumes:
      - ./fixtures:/data/fixtures:ro
    networks:
      - cync_test_network

networks:
  cync_test_network:
    driver: bridge

volumes:
  test_config:
