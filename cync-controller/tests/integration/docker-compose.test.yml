version: "3.8"

services:
  # EMQX MQTT Broker for testing
  emqx:
    image: emqx/emqx:5.8.0
    container_name: cync_test_emqx
    ports:
      - "1883:1883" # MQTT
      - "18083:18083" # Dashboard
    environment:
      - EMQX_NAME=test_broker
      - EMQX_HOST=127.0.0.1
      - EMQX_LOADED_PLUGINS="emqx_dashboard,emqx_management,emqx_auth_mnesia"
    healthcheck:
      test: ["CMD", "emqx", "ping"]
      interval: 5s
      timeout: 10s
      retries: 5
    networks:
      - cync_test_network

  # Cync Controller Add-on under test
  cync-controller:
    build:
      context: ../..
      dockerfile: Dockerfile
      args:
        BUILD_FROM: python:3.13-alpine
        BUILD_ARCH: amd64
        BUILD_VERSION: test
    container_name: cync_test_controller
    depends_on:
      emqx:
        condition: service_healthy
    environment:
      - CYNC_HOST=0.0.0.0
      - CYNC_DEBUG=1
      - CYNC_RAW_DEBUG=1
      - CYNC_TOPIC=cync_lan_test
      - CYNC_MQTT_HOST=emqx
      - CYNC_MQTT_PORT=1883
      - CYNC_MQTT_USER=test_user
      - CYNC_MQTT_PASS=test_pass
      - CYNC_HASS_TOPIC=homeassistant
      - CYNC_HASS_STATUS_TOPIC=status
      - CYNC_HASS_BIRTH_MSG=online
      - CYNC_HASS_WILL_MSG=offline
      - CYNC_MQTT_CONN_DELAY=2
      - CYNC_CMD_BROADCASTS=2
      - CYNC_MAX_TCP_CONN=8
      - CYNC_TCP_WHITELIST=""
      # Cloud relay options (disabled by default for LAN-only testing)
      - CYNC_CLOUD_RELAY_ENABLED=false
      - CYNC_CLOUD_FORWARD=false
    ports:
      - "23779:23779" # Device TCP port
      - "23778:23778" # Web interface
      - "5678:5678" # Debug port
    volumes:
      - ./fixtures:/data/fixtures:ro
    networks:
      - cync_test_network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "23779"]
      interval: 5s
      timeout: 5s
      retries: 3

  # Mock Cync Device for testing
  mock-device:
    build:
      context: ./mock-device
      dockerfile: Dockerfile
    container_name: cync_test_device
    depends_on:
      cync-controller:
        condition: service_healthy
    environment:
      - CYNC_SERVER_HOST=cync-controller
      - CYNC_SERVER_PORT=23779
      - DEVICE_ID=0x1234
      - DEVICE_NAME=Test Light 1
      - DEVICE_ROOM=Living Room
    volumes:
      - ./fixtures:/data/fixtures:ro
    networks:
      - cync_test_network

networks:
  cync_test_network:
    driver: bridge
