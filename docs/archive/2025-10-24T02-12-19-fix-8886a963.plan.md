<!-- 8886a963-68ca-4600-aee3-9d2f8ef51625 188298b6-ce28-4b3a-b9b0-88ef4be7d8a7 -->
# Fix Cync switch state + add grouped light control

## Goals

- Switch entities show correct ON/OFF state in HA.
- Keep command flow/ACK handling intact (no auto-refresh).
- Expose a unified light entity (per group) with brightness and color temperature for smart Cync bulbs.

## What’s likely wrong

- Switch state is published as JSON without a value template; HA’s MQTT switch expects plain ON/OFF unless `value_template` is provided.

Key code locations:

- `cync-controller/src/cync_lan/mqtt_client.py` (~608–640): `update_device_state` publishes state
- `cync-controller/src/cync_lan/mqtt_client.py` (~1224–1240): discovery `entity_registry_struct`
- `cync-controller/src/cync_lan/server.py` (~545–557): status publish path

## Plan — Switch state fix (default approach)

### Progress

- Implemented: Switch state now publishes plain `ON`/`OFF` (no JSON) and switch discovery no longer declares `schema: json`.
- Rebuilt and restarted the add-on to apply changes.
- Completed: Clean MQTT rediscovery using `scripts/delete-mqtt-safe.py`.
- Root cause: wrong HA data path in script; updated `HA_CONFIG_DIR` to `/tmp/supervisor_data/homeassistant`.
- Ran dry-run, then deletion; restarted HA core and add-on.
- Verified in logs: group discovery registered multiple groups; switches publish `b'ON'`/`b'OFF'` on birth.
- Completed: HA toggle test via MQTT command topics
- Published `OFF` then `ON` to `cync_controller_addon/set/467454691-26`
- Logs show ACK then state update with plain `b'ON'`/`b'OFF'` for switches
- No auto-refresh added; state follows ACKs as designed

1) Observe current MQTT

- Subscribe: `mosquitto_sub -v -t 'homeassistant/+/+/config'` and `-t 'cync/status/#'`.
- Confirm switch config has no `value_template`, and state payload is JSON.

2) Publish plain ON/OFF for switches

- Change switch state publish to raw bytes `ON`/`OFF` instead of JSON.
- Edit `mqtt_client.update_device_state`: for `device.is_switch`, set `mqtt_dev_state = power_status.encode()`.
- Ensure discovery for switches does NOT include light-only keys; remove reliance on `schema: json` for switches if present. Leaving unknown `schema` is harmless, but we’ll omit it for clarity.

3) Validate end-to-end

- Restart/rebuild per workflow; delete stale MQTT entities if schema changed.
- Toggle physical and HA UI; verify state updates immediately after ACK.

Alternative (if you prefer JSON state):

- Keep JSON payload but add to switch discovery:
- `value_template: '{{ value_json.state }}'`
- `command_template: '{"state":"{{ value }}"}'`
- This is more complex and offers no advantage for plain switches.

## Grouped light control (brightness/color temp)

Leverage existing group discovery and state publishing to expose a light per group of smart bulbs.

Key code locations:

- `cync-controller/src/cync_lan/mqtt_client.py` (~1347–1386): subgroup discovery as lights
- `cync-controller/src/cync_lan/mqtt_client.py` (~729–759): `publish_group_state`
- `cync-controller/src/cync_lan/devices.py` (~1367–1421): `CyncGroup` capabilities

Steps:

1) Ensure groups are parsed from mesh/config and registered

- `utils.parse_config` creates `CyncGroup` entries; discovery publishes `light` entities per subgroup.
- If your bulbs are in the same room/group the wall switch controls, the group entity gives a single UI control for brightness/CT.

2) Map switch → group (optional convenience)

- If desired, expose an additional “virtual light” entity linked to the same group the switch controls (config flag like `expose_switch_as_light: true`). Commands from that entity route to `CyncGroup.set_*`.
- Keep the original switch entity for binary control, but recommend users favor the group light.

3) Dimmer switch readiness

- When a dimmer switch is added, treat it as a control surface: publish HA state from ACKs; for user-facing brightness, prefer the group light entity (derived from bulbs) instead of overloading the switch entity type.

## Tests & verification

- MQTT: verify discovery for `homeassistant/switch/.../config` and `homeassistant/light/.../config`.
- Toggle devices physically and via HA; confirm:
- Switch entity reflects state within ~1–2s.
- Group light can set brightness and color temperature for member bulbs.
- If discovery schema changed, run entity cleanup script and re-discover.

## Operational notes

- Python edits require: `npm run lint:python:fix && npm run format:python && npm run lint` then `cd cync-controller && ./rebuild.sh`.
- Don’t add auto-refresh after ACKs; rely on existing callback + publish.
- For schema changes, clear stale entities (`scripts/delete-mqtt-safe.py`) and restart add-on.

### To-dos

- [x] Audit MQTT discovery/state for switches and groups (config and status topics)
- [x] Publish plain ON/OFF for switches; remove JSON for switch state
- [x] Ensure switch discovery omits light-only schema and templates as needed
- [x] Delete stale MQTT entities and restart add-on for clean rediscovery
- [x] Test HA toggles via MQTT; confirm timely switch state updates
- [x] Test physical toggles; confirm timely switch state updates
- [x] Verify groups parsed and discover light entities with color modes
- [ ] Add optional config to expose per-switch virtual light mapped to group
- [ ] Prepare for dimmer switch: validate status and prefer group light for brightness