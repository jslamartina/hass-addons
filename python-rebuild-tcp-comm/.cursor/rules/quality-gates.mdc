---
description: Quality gates and CI requirements
---

# Quality Gates

## Lint-First Rule

### Never commit code that fails linting

```bash
## Check before commit
poetry run ruff check .

## Auto-fix (when safe)
poetry run ruff check --fix .
```

## Ruff Configuration

### Line Length

Set to 100 in `pyproject.toml`:

```toml
[tool.ruff]
line-length = 100
```

### Running Ruff

```bash
## Check all files
poetry run ruff check .

## Check specific file
poetry run ruff check src/transport/socket_abstraction.py

## Show rule violations
poetry run ruff check --output-format=full .
```

### Common Violations

- `E501`: Line too long (> 100 chars)
- `F401`: Unused import
- `F841`: Unused variable
- `W291`: Trailing whitespace

## Pyright Type Checking

### Strict Mode

Enabled in `pyrightconfig.json`:

```json
{
  "typeCheckingMode": "strict",
  "pythonVersion": "3.13"
}
```

### Running Pyright

```bash
## Check all code
pyright python-rebuild-tcp-comm/src python-rebuild-tcp-comm/tests

## Check specific file
pyright python-rebuild-tcp-comm/src/transport/socket_abstraction.py
```

### Type Checking Requirements

1. **All functions have type hints**:

```python
def parse(data: bytes) -> dict[str, Any]:
    ...
```

1. **Return types explicit**:

```python
async def connect() -> bool:
    ...
```

1. **No `Any` without justification**:

```python
## Bad
def process(data: Any) -> Any:
    ...

## Good
def process(data: dict[str, str]) -> list[str]:
    ...
```

## Coverage Threshold

### 90% Minimum

Enforced in `pyproject.toml`:

```toml
[tool.coverage.report]
fail_under = 90
precision = 2
show_missing = true
```

### Check Coverage

```bash
## Run tests with coverage
./scripts/test-all.sh -c

## View report
poetry run pytest --cov --cov-report=term

## HTML report
poetry run pytest --cov --cov-report=html
```

### Coverage Exclusions

Acceptable uncovered code:

- Defensive error handling for rare cases
- Debug logging branches
- Type narrowing guards (pyright only)

Mark with pragma:

```python
if TYPE_CHECKING:  # pragma: no cover
    from typing import Protocol
```

## CI Workflow

### GitHub Actions Pipeline

Located at `.github/workflows/ci.yml`:

```yaml
- Lint with ruff
- Type check with pyright
- Run tests with coverage
- Upload test results
```

### All Steps Must Pass

CI enforces:

1. **Ruff**: `poetry run ruff check .` (exit 0)
2. **Pyright**: `pyright python-rebuild-tcp-comm/src python-rebuild-tcp-comm/tests` (exit 0)
3. **Tests**: `poetry run pytest` with 90% coverage

### Local Verification

Run full CI checks locally:

```bash
## Lint
poetry run ruff check .

## Type check
pyright python-rebuild-tcp-comm/src python-rebuild-tcp-comm/tests

## Tests with coverage
poetry run pytest --cov --cov-report=term --cov-fail-under=90

## Or use helper
./scripts/build.sh
```

## Helper Scripts for Quality

### test-all.sh

Runs all tests with optional coverage:

```bash
./scripts/test-all.sh    # Run all tests
./scripts/test-all.sh -c # With coverage report
./scripts/test-all.sh -v # Verbose output
```

### build.sh

Full build verification (lint + type check + test):

```bash
./scripts/build.sh
```

Runs:

1. Ruff linting
2. Pyright type checking
3. All tests with coverage
4. Validates against 90% threshold

## Pre-Commit Checklist

Before committing:

1. ✓ Run ruff: `poetry run ruff check .`
2. ✓ Run pyright: `pyright python-rebuild-tcp-comm/src python-rebuild-tcp-comm/tests`
3. ✓ Run tests: `./scripts/test-all.sh`
4. ✓ Check coverage: `./scripts/test-all.sh -c`

Or run all at once:

```bash
./scripts/build.sh
```

## Common Quality Issues

### Import Errors

```python
## Bad - unused import
from transport import TCPConnection

## Good - remove or use
## (import removed if unused)
```

### Type Annotation Missing

```python
## Bad - pyright error
def process(data):
    return data.decode()

## Good - explicit types
def process(data: bytes) -> str:
    return data.decode()
```

### Line Too Long

```python
## Bad - > 100 chars
logger.info(f"Very long message with lots of details: device={device_id}, state={state}, result={result}")

## Good - split lines
logger.info(
    "Operation complete",
    extra={"device_id": device_id, "state": state, "result": result}
)
```

## Quality Metrics

Track in CI:

- Lint violations: 0 required
- Type errors: 0 required
- Test failures: 0 required
- Coverage: ≥90% required

## Debugging Quality Failures

### Ruff Failures

```bash
## Show full error details
poetry run ruff check --output-format=full .

## Show which rule violated
poetry run ruff check --show-source .
```

### Pyright Failures

```bash
## Verbose error output
pyright python-rebuild-tcp-comm/src python-rebuild-tcp-comm/tests --verbose

## Check specific module
pyright python-rebuild-tcp-comm/src/transport/
```

### Coverage Gaps

```bash
## Show missing lines
poetry run pytest --cov --cov-report=term-missing

## HTML report with highlighting
poetry run pytest --cov --cov-report=html
open htmlcov/index.html
```
